name: Weekly Victoria Gigs Update

on:
  workflow_dispatch:
  schedule:
    - cron: "0 8 * * 0"

jobs:
  direct_jambase_db_update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20.12.1"

      - name: Install dependencies
        working-directory: scripts
        run: npm install

      - name: Run script
        env:
          ATLAS_URI: ${{ secrets.ATLAS_URI }}
          API_KEY_JAMBASE: ${{ secrets.API_KEY_JAMBASE }}
          SP_REFRESH_TOKEN: ${{ secrets.SP_REFRESH_TOKEN }}
          SP_CLIENT_ID: ${{ secrets.SP_CLIENT_ID }}
          SP_CLIENT_S: ${{ secrets.SP_CLIENT_S }}
        run: node ./scripts/src/updateVictoriaDatabase.js

  extract_songkick_and_create_pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: "20.12.1"

      - name: Install dependencies
        working-directory: scripts
        run: npm install

      - name: Run extractSongkick
        run: npx ts-node ./scripts/src/scrapers/songkick/extractSongkick.ts > ./scripts/src/scrapers/songkick/extractedVicGigs.json

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Add extractedVicGigs.json"
          title: "Weekly Update: Extracted Victoria Songkick Data"
          body: "This PR contains the JSON object of the Songkick data extracted this week.\nIt does not include Spotify data\nMerge this PR to trigger the action to add spotify data and update the database."
          branch: weekly-vic-songkick-data
          base: main
          files: |
            extractedVicGigs.json
          labels: weekly-update
